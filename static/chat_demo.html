<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B0 ì±„íŒ… ë°ëª¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .chat-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 600px;
            height: 700px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .chat-header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .status {
            font-size: 14px;
            opacity: 0.9;
        }

        .status.connected {
            color: #4ade80;
        }

        .status.disconnected {
            color: #f87171;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f9fafb;
        }

        .message {
            margin-bottom: 16px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.system {
            text-align: center;
        }

        .message.system .content {
            display: inline-block;
            background: #e5e7eb;
            color: #6b7280;
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 14px;
        }

        .message.user {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .message-header {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .content {
            background: white;
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .message.me .content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.me {
            align-items: flex-end;
        }

        .timestamp {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 4px;
        }

        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e5e7eb;
        }

        .input-container {
            display: flex;
            gap: 10px;
        }

        #messageInput {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.2s;
        }

        #messageInput:focus {
            border-color: #667eea;
        }

        #sendButton {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #sendButton:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        #sendButton:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .info {
            text-align: center;
            padding: 20px;
            color: #6b7280;
            font-size: 14px;
        }

        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 20px;
            font-size: 14px;
        }
    </style>
    <!-- Socket.IO Client CDN -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js" crossorigin="anonymous"></script>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>ğŸš€ B0 ì±„íŒ… ë°ëª¨</h1>
            <div class="status" id="status">ì—°ê²° ì¤‘...</div>
        </div>

        <div class="messages" id="messages">
            <div class="info">
                ì±„íŒ…ë°©ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤.<br>
                ì—¬ëŸ¬ ë¸Œë¼ìš°ì € íƒ­ì„ ì—´ì–´ì„œ ì‹¤ì‹œê°„ ì±„íŒ…ì„ í…ŒìŠ¤íŠ¸í•´ë³´ì„¸ìš”!
            </div>
        </div>

        <div class="input-area">
            <div class="input-container">
                <input
                    type="text"
                    id="messageInput"
                    placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                    disabled
                />
                <button id="sendButton" disabled>ì „ì†¡</button>
            </div>
        </div>
    </div>

    <script>
        let socket = null;
        let myUserId = null;

        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const statusDiv = document.getElementById('status');
        const currentRoomId = "00000000-0000-0000-0000-000000000000";

        function connect() {
            // Socket.IO ì—°ê²° (ë°ëª¨ ë„¤ì„ìŠ¤í˜ì´ìŠ¤)
            socket = io('http://localhost:8000/demo', {
                path: '/ws/socket.io',
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionDelay: 2000,
                reconnectionAttempts: 5,
            });

            // ì—°ê²° ì„±ê³µ
            socket.on('connect', () => {
                console.log('Socket.IO ì—°ê²°ë¨ (ID:', socket.id, ')');
                socket.emit('join_room', { 
                    room_id: currentRoomId
                });
                updateStatus('connected');
                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.focus();
            });

            // user_id ìˆ˜ì‹ 
            socket.on('connected', (data) => {
                myUserId = data.user_id;
                console.log('ë‚´ user_id:', myUserId);
            });

            // ì—°ê²° í•´ì œ
            socket.on('disconnect', (reason) => {
                console.log('Socket.IO ì—°ê²° í•´ì œ:', reason);
                updateStatus('disconnected');
                messageInput.disabled = true;
                sendButton.disabled = true;
            });

            // ì¬ì—°ê²° ì‹œë„
            socket.on('reconnect_attempt', (attemptNumber) => {
                console.log(`ì¬ì—°ê²° ì‹œë„ ì¤‘... (${attemptNumber}ë²ˆì§¸)`);
                updateStatus('reconnecting');
            });

            // ì¬ì—°ê²° ì„±ê³µ
            socket.on('reconnect', (attemptNumber) => {
                console.log(`ì¬ì—°ê²° ì„±ê³µ! (${attemptNumber}ë²ˆ ì‹œë„ í›„)`);
                updateStatus('connected');
            });

            // ì¬ì—°ê²° ì‹¤íŒ¨
            socket.on('reconnect_failed', () => {
                console.error('ì¬ì—°ê²° ì‹¤íŒ¨');
                showError('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.');
            });

            // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ìˆ˜ì‹ 
            socket.on('system_message', (data) => {
                console.log('ì‹œìŠ¤í…œ ë©”ì‹œì§€:', data);
                addSystemMessage(data.message);
            });

            // ì¼ë°˜ ë©”ì‹œì§€ ìˆ˜ì‹ 
            socket.on('new_message', (data) => {
                console.log('ë©”ì‹œì§€ ìˆ˜ì‹ :', data);
                addUserMessage(data.message);
            });

            // ì—ëŸ¬ ë©”ì‹œì§€ ìˆ˜ì‹ 
            socket.on('error', (data) => {
                console.error('ì—ëŸ¬:', data);
                showError(data.error);
            });

            // Socket.IO ì—ëŸ¬
            socket.on('connect_error', (error) => {
                console.error('ì—°ê²° ì—ëŸ¬:', error);
                showError('ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }

        function updateStatus(status) {
            if (status === 'connected') {
                statusDiv.textContent = 'ğŸŸ¢ ì—°ê²°ë¨';
                statusDiv.className = 'status connected';
            } else if (status === 'reconnecting') {
                statusDiv.textContent = 'ğŸŸ¡ ì¬ì—°ê²° ì¤‘...';
                statusDiv.className = 'status';
            } else {
                statusDiv.textContent = 'ğŸ”´ ì—°ê²° ëŠê¹€';
                statusDiv.className = 'status disconnected';
            }
        }

        function addSystemMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';
            messageDiv.innerHTML = `
                <div class="content">${escapeHtml(message.content)}</div>
            `;
            messagesDiv.appendChild(messageDiv);
            scrollToBottom();
        }

        function addUserMessage(message) {
            const isMe = myUserId && message.user_id === myUserId;

            const messageDiv = document.createElement('div');
            messageDiv.className = `message user ${isMe ? 'me' : ''}`;

            const time = new Date(message.created_at).toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit'
            });

            messageDiv.innerHTML = `
                ${!isMe ? `<div class="message-header">ì‚¬ìš©ì ${message.user_id.substring(0, 8)}...</div>` : ''}
                <div class="content">${escapeHtml(message.content)}</div>
                <div class="timestamp">${time}</div>
            `;
            messagesDiv.appendChild(messageDiv);
            scrollToBottom();
        }

        function showError(error) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = `âš ï¸ ${error}`;
            messagesDiv.appendChild(errorDiv);
            scrollToBottom();

            // 5ì´ˆ í›„ ì—ëŸ¬ ë©”ì‹œì§€ ì œê±°
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        function sendMessage() {
            const content = messageInput.value.trim();
            if (!content || !socket || !socket.connected) {
                return;
            }

            // Socket.IO ì´ë²¤íŠ¸ë¡œ ë©”ì‹œì§€ ì „ì†¡
            socket.emit('send_message', { content: content });

            messageInput.value = '';
            messageInput.focus();
        }

        function scrollToBottom() {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // ì´ˆê¸° ì—°ê²°
        connect();
    </script>
</body>
</html>
